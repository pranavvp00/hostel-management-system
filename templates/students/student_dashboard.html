{% extends 'base.html' %}
{% load static %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}
<style>
  /* Gradient headers */
  .section-header {
    background: linear-gradient(90deg, #7a4bff, #00e1c6);
    color: white !important;
  }

  /* Card animations */
  .dash-card {
    border-radius: 15px;
    transition: 0.3s;
  }
  .dash-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }

  /* Buttons */
  .btn-gradient {
    background: linear-gradient(120deg, #7a4bff, #00e1c6);
    border: none;
    color: white;
    font-weight: 600;
    transition: 0.3s;
  }
  .btn-gradient:hover {
    opacity: 0.85;
    transform: scale(1.03);
  }

  .badge-gradient {
    background: linear-gradient(120deg, #7a4bff, #00e1c6);
  }
</style>

<div class="container mt-4" data-aos="fade-up">

  <!-- Toast Notifications -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div class="toast-container position-fixed top-0 end-0 p-3">
      {% if messages %}
        {% for message in messages %}
          <div class="toast align-items-center text-white bg-success border-0 mb-2"
               data-bs-delay="4000">
            <div class="d-flex">
              <div class="toast-body"><i class="ri-check-line me-2"></i>{{ message }}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  <!-- PROFILE CARD -->
  <div class="card dash-card mb-4" data-aos="fade-right">
    <div class="card-body d-flex align-items-center">

      {% if profile.photo %}
        <img src="{{ profile.photo.url }}" class="rounded-circle me-3" width="80" height="80">
      {% else %}
        <img src="{% static 'images/default_profile.png' %}" class="rounded-circle me-3" width="80" height="80">
      {% endif %}

      <div>
        <h4 class="fw-bold"><i class="ri-user-line me-2"></i>{{ user.username }}</h4>
        <p><i class="ri-mail-line"></i> {{ user.email }}</p>
        <p><i class="ri-phone-line"></i> {{ profile.phone_number|default:"Not Provided" }}</p>
        <p><i class="ri-user-heart-line"></i> Guardian: {{ profile.guardian_number|default:"Not Provided" }}</p>
        <p><i class="ri-map-pin-line"></i> {{ profile.address|default:"Not Provided" }}</p>

        <p class="mb-1">
          {% if profile.hostel and profile.room %}
            <i class="ri-building-4-line"></i> Hostel: <strong>{{ profile.hostel.name }}</strong>  
            | Room: <strong>{{ profile.room.room_number }}</strong>
          {% elif profile.hostel %}
            <i class="ri-building-4-line"></i> Hostel: {{ profile.hostel.name }}  
            <span class="text-muted">(Room not assigned)</span>
          {% else %}
            <span class="text-danger"><i class="ri-close-circle-line"></i> Not assigned to any hostel</span>
          {% endif %}
        </p>

        <a href="{% url 'edit_profile' %}" class="btn btn-gradient btn-sm mt-2">
          <i class="ri-edit-2-line"></i> Edit Profile
        </a>
      </div>
    </div>
  </div>

  <!-- NOTICES -->
  {% if notices %}
    <div class="card dash-card mb-4" data-aos="fade-left">
      <div class="card-header section-header">
        <h5 class="mb-0"><i class="ri-notification-2-line me-2"></i>Notices from Warden</h5>
      </div>

      <ul class="list-group list-group-flush">
        {% for notice in notices %}
          <li class="list-group-item">
            <i class="ri-chat-1-line text-primary me-2"></i>
            {{ notice.message }}
            {% if notice.date_sent %}
              <small class="text-muted float-end">
                <i class="ri-time-line me-1"></i>{{ notice.date_sent }}
              </small>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- PAYMENTS -->
  {% if profile.hostel and profile.request_status == 'approved' %}
    <div class="card dash-card mb-4" data-aos="zoom-in">
      <div class="card-header section-header">
        <h5 class="mb-0"><i class="ri-bank-card-line me-2"></i>Payments & Reports</h5>
      </div>

      <div class="card-body d-flex gap-2">
        <a href="{% url 'make_payment' %}" class="btn btn-success w-50">
          <i class="ri-money-rupee-circle-line me-1"></i> Make Payment
        </a>

        <a href="{% url 'send_report' %}" class="btn btn-warning w-50">
          <i class="ri-alert-line me-1"></i> Send Report to Admin
        </a>
      </div>
    </div>
  {% endif %}

  <!-- HOSTELS LIST -->
  <h3 class="fw-bold mb-3" data-aos="fade-up">
    <i class="ri-building-line me-2"></i> Hostels & Mess Menu
  </h3>

  <div class="row">

    {% for hostel in hostels %}
      <div class="col-md-6 mb-4">
        <div class="card dash-card h-100" data-aos="fade-up">

          <div class="card-header section-header">
            <h5 class="mb-0"><i class="ri-home-4-line me-2"></i>{{ hostel.name }}</h5>
          </div>

          <div class="card-body">

            <p><strong><i class="ri-map-pin-line"></i> Location:</strong> {{ hostel.location }}</p>
            <p><strong><i class="ri-group-line"></i> Capacity:</strong> {{ hostel.capacity }}</p>

            <p>
              <span class="badge badge-gradient text-white">
                ‚Çπ{{ hostel.room_rent }} / month
              </span>
            </p>

            <p>{{ hostel.description|truncatechars:100 }}</p>

            <!-- WARDEN -->
            {% if hostel.warden %}
              <p><strong>üë®‚Äçüíº Warden:</strong> {{ hostel.warden.user.username }}</p>
              <p><strong>üìû Phone:</strong> {{ hostel.warden.phone|default:"Not Provided" }}</p>
            {% else %}
              <p><strong>Warden:</strong> <span class="text-danger">Not Assigned</span></p>
            {% endif %}

            <!-- CAROUSEL -->
            {% if hostel.gallery_groups.exists %}
              <div id="carousel{{ hostel.id }}" class="carousel slide mb-3" data-bs-ride="carousel">
                <div class="carousel-inner">

                  {% for group in hostel.gallery_groups.all %}
                    {% for img in group.images.all %}
                      <div class="carousel-item {% if forloop.first and forloop.parentloop.first %}active{% endif %}">
                        <img src="{{ img.image.url }}" class="d-block w-100 rounded"
                             style="height:200px; object-fit:cover;">
                        {% if group.caption %}
                          <div class="carousel-caption d-none d-md-block">
                            <small>{{ group.caption }}</small>
                          </div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  {% endfor %}

                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ hostel.id }}" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon"></span>
                </button>

                <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ hostel.id }}" data-bs-slide="next">
                  <span class="carousel-control-next-icon"></span>
                </button>

              </div>
            {% else %}
              <p class="text-muted">No gallery images available.</p>
            {% endif %}

            <!-- MESS MENU -->
            {% if hostel.menus.exists %}
              <h6 class="fw-bold mt-3">üçΩÔ∏è Mess Menu</h6>
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Day</th>
                    <th>Menu</th>
                  </tr>
                </thead>
                <tbody>
                  {% for menu in hostel.menus.all %}
                    <tr>
                      <td>{{ menu.day }}</td>
                      <td>{{ menu.items }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}

            <!-- REQUEST BUTTON -->
            <div class="mt-3">
              {% if profile.hostel %}
                {% if profile.request_status == 'approved' %}
                  <button class="btn btn-secondary w-100" disabled>
                    Already in {{ profile.hostel.name }}
                  </button>
                {% endif %}
              {% elif hostel.capacity <= 0 %}
                <button class="btn btn-warning w-100" disabled>Full</button>
              {% else %}
                <form action="{% url 'request_hostel' hostel.id %}" method="post">
                  {% csrf_token %}
                  <button class="btn btn-gradient w-100">Request to Join</button>
                </form>
              {% endif %}
            </div>

          </div>
        </div>
      </div>
    {% endfor %}

  </div>

</div>

<script>
  const toasts = document.querySelectorAll('.toast');
  toasts.forEach(t => new bootstrap.Toast(t).show());
</script>

{% endblock %}
